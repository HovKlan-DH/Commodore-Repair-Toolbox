name: Build and Release (Windows/Linux/macOS)

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Version for this release (ex. 2.0.0)'
        required: true
        default: '1.9.0'

env:
  PACK_ID: Commodore-Repair-Toolbox
  EXE_WINDOWS: Commodore-Repair-Toolbox.exe
  EXE_UNIX: Commodore-Repair-Toolbox
  PROJECT: CRT2.csproj
  DATA_PACK_URL: https://commodore-repair-toolbox.dk/auto-data/Data.zip

jobs:

  ###############################################################
  # WINDOWS BUILD (x64)
  ###############################################################
  build-windows:
    name: Build Windows (x64)
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: crt-v2

      - name: Set version
        id: ver
        shell: powershell -ExecutionPolicy Bypass -File "{0}"
        run: |
          $tag = if ("${{ github.event_name }}" -eq "workflow_dispatch") { "${{ inputs.tag_name }}" } else { "${{ github.ref_name }}" }
          "version=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Publish Windows (x64)
        run: |
          dotnet publish ${{ env.PROJECT }} `
            -c Release `
            -r win-x64 `
            --self-contained `
            -p:Version=${{ steps.ver.outputs.version }} `
            -o publish/windows-x64

      - name: List available certificates
        shell: powershell
        run: Get-ChildItem Cert:\CurrentUser\My | Select-Object Subject, Thumbprint
  
      - name: Sign executable
        shell: powershell
        env:
          YUBIKEY_PIN: ${{ secrets.YUBIKEY_PIN }}
        run: |
          java -jar C:\tools\jsign.jar `
            --storetype YUBIKEY `
            --storepass "$env:YUBIKEY_PIN" `
            --tsaurl http://timestamp.digicert.com `
            --alg SHA-256 `
            publish/windows-x64/${{ env.EXE_WINDOWS }}

      - name: Download and extract data pack
        shell: pwsh
        run: |
          Invoke-WebRequest "${{ env.DATA_PACK_URL }}" -OutFile data-pack.zip
          Expand-Archive data-pack.zip -DestinationPath publish/windows-x64/Data/

      - name: Install vpk
        run: dotnet tool install -g vpk

      - name: Pack with Velopack
        run: |
          vpk pack `
            --packId ${{ env.PACK_ID }} `
            --packVersion ${{ steps.ver.outputs.version }} `
            --packDir publish/windows-x64 `
            --mainExe ${{ env.EXE_WINDOWS }} `
            --noPortable `
            --icon "Assets/Commodore icon.ico" `
            --outputDir velopack-output

      - name: Upload Velopack artifacts
        uses: actions/upload-artifact@v4
        with:
          name: velopack-windows-x64
          path: velopack-output/*

  ###############################################################
  # LINUX BUILD (x64)
  ###############################################################
  build-linux:
    name: Build Linux (x64)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: crt-v2

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Publish Linux (x64)
        run: |
          dotnet publish ${{ env.PROJECT }} \
            -c Release \
            -r linux-x64 \
            --self-contained \
            -p:Version=${{ steps.ver.outputs.version }} \
            -o publish/linux-x64

      - name: Download and extract data pack
        run: |
          curl -fsSL "${{ env.DATA_PACK_URL }}" -o data-pack.zip
          unzip data-pack.zip -d publish/linux-x64/Data/

      - name: Install vpk
        run: dotnet tool install -g vpk

      - name: Pack with Velopack
        run: |
          vpk pack \
            --packId ${{ env.PACK_ID }} \
            --packVersion ${{ steps.ver.outputs.version }} \
            --packDir publish/linux-x64 \
            --mainExe ${{ env.EXE_UNIX }} \
            --icon "Assets/Commodore icon.ico" \
            --outputDir velopack-output

      - name: Upload Velopack artifacts
        uses: actions/upload-artifact@v4
        with:
          name: velopack-linux-x64
          path: velopack-output/*

  ###############################################################
  # MACOS BUILD (arm64 + x64 from single runner)
  ###############################################################
  build-macos:
    name: Build macOS (arm64 + x64)
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: crt-v2
          
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Publish macOS (arm64)
        run: |
          dotnet publish ${{ env.PROJECT }} \
            -c Release \
            -r osx-arm64 \
            --self-contained \
            -p:Version=${{ steps.ver.outputs.version }} \
            -o publish/macos-arm64

      - name: Publish macOS (x64)
        run: |
          dotnet publish ${{ env.PROJECT }} \
            -c Release \
            -r osx-x64 \
            --self-contained \
            -p:Version=${{ steps.ver.outputs.version }} \
            -o publish/macos-x64

      - name: Download and extract data pack
        run: |
          curl -fsSL "${{ env.DATA_PACK_URL }}" -o data-pack.zip
          unzip data-pack.zip -d publish/macos-arm64/Data/
          unzip data-pack.zip -d publish/macos-x64/Data/

      - name: Install vpk
        run: dotnet tool install -g vpk

      - name: Pack with Velopack (macOS arm64)
        run: |
          vpk pack \
            --packId ${{ env.PACK_ID }} \
            --packVersion ${{ steps.ver.outputs.version }} \
            --packDir publish/macos-arm64 \
            --mainExe ${{ env.EXE_UNIX }} \
            --channel osx-arm64 \
            --noPortable \
            --icon "Assets/Commodore icon.ico" \
            --outputDir velopack-output

      - name: Pack with Velopack (macOS x64)
        run: |
          vpk pack \
            --packId ${{ env.PACK_ID }} \
            --packVersion ${{ steps.ver.outputs.version }} \
            --packDir publish/macos-x64 \
            --mainExe ${{ env.EXE_UNIX }} \
            --channel osx-x64 \
            --noPortable \
            --icon "Assets/Commodore icon.ico" \
            --outputDir velopack-output

      - name: Upload Velopack artifacts
        uses: actions/upload-artifact@v4
        with:
          name: velopack-macos
          path: velopack-output/*

  ###############################################################
  # CREATE GITHUB RELEASE
  ###############################################################
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux, build-macos]
    permissions:
      contents: write
    steps:
      - name: Download all Velopack artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Set release tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ inputs.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "ALPHA - Commodore Repair Toolbox ${{ steps.tag.outputs.tag }}"
          body: |
            ## ⚠️ This is an ALPHA release - NOT a stable release!!!

            If you are looking for the normal/stable version, then look below and find the **2026-February-21** release.
            
            **CRT 2** is a new application built from scratch to natively support **Windows**, **Linux** and **macOS**. There will be many alpha-releases until the final version will be named **2.0.0**. Please support by giving your comments, if this works or not, and what needs improvement.

            You only need to install the application once, and thereafter you can update directly from inside the application.
            
            ### Downloads
            | Platform | File |
            |----------|------|
            | Windows x64 | [Commodore-Repair-Toolbox-win-Setup.exe](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/Commodore-Repair-Toolbox-win-Setup.exe) |
            | Linux x64 | [Commodore-Repair-Toolbox.AppImage](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/Commodore-Repair-Toolbox.AppImage) |
            | macOS arm64 Apple Silicon | [Commodore-Repair-Toolbox-osx-arm64-Setup.pkg](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/Commodore-Repair-Toolbox-osx-arm64-Setup.pkg) |
            | macOS x64 Intel | [Commodore-Repair-Toolbox-osx-x64-Setup.pkg](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/Commodore-Repair-Toolbox-osx-x64-Setup.pkg) |
          draft: false
          prerelease: true
          files: |
            release-assets/*-Setup.exe
            release-assets/*.AppImage
            release-assets/*-Setup.pkg
            release-assets/*.nupkg
            release-assets/releases.*.json
            release-assets/assets.*.json

name: Build and Release (Windows/Linux/macOS)

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Version for this release (ex. 2.0.0.1)'
        required: true
        default: '2.0.0'

env:
  PACK_ID: Commodore-Repair-Toolbox
  EXE_WINDOWS: Commodore-Repair-Toolbox.exe
  EXE_UNIX: Commodore-Repair-Toolbox
  PROJECT: CRT2.csproj

jobs:

  ###############################################################
  # WINDOWS BUILD (x64)
  ###############################################################
  build-windows:
    name: Build Windows (x64)
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: crt-v2

      - name: Verify tag is on "crt-v2" branch
        if: github.event_name == 'push'
        run: |
          git fetch --all
          BRANCH=$(git branch -r --contains ${{ github.sha }} | grep 'origin/crt-v2' || true)
          if [ -z "$BRANCH" ]; then
            echo "::error::This tag was not created from the \"crt-v2\" branch - aborting..."
            exit 1
          fi
          
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Set version
        id: ver
        shell: bash
        run: |
          TAG=$([[ "${{ github.event_name }}" == "workflow_dispatch" ]] && echo "${{ inputs.tag_name }}" || echo "${{ github.ref_name }}")
          echo "version=$TAG" >> $GITHUB_OUTPUT

      - name: Publish Windows (x64)
        run: |
          dotnet publish ${{ env.PROJECT }} `
            -c Release `
            -r win-x64 `
            --self-contained `
            -p:Version=${{ steps.ver.outputs.version }} `
            -o publish/windows-x64

      - name: Install vpk
        run: dotnet tool install -g vpk

      - name: Pack with Velopack
        run: |
          vpk pack `
            --packId ${{ env.PACK_ID }} `
            --packVersion ${{ steps.ver.outputs.version }} `
            --packDir publish/windows-x64 `
            --mainExe ${{ env.EXE_WINDOWS }} `
            --noPortable `
            --outputDir velopack-output

      - name: Upload Velopack artifacts
        uses: actions/upload-artifact@v4
        with:
          name: velopack-windows-x64
          path: velopack-output/*

  ###############################################################
  # LINUX BUILD (x64)
  ###############################################################
  build-linux:
    name: Build Linux (x64)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: crt-v2

      - name: Verify tag is on "crt-v2" branch
        if: github.event_name == 'push'
        run: |
          git fetch --all
          BRANCH=$(git branch -r --contains ${{ github.sha }} | grep 'origin/crt-v2' || true)
          if [ -z "$BRANCH" ]; then
            echo "::error::This tag was not created from the \"crt-v2\" branch - aborting..."
            exit 1
          fi
          
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Set version
        id: ver
        run: |
          TAG=$([[ "${{ github.event_name }}" == "workflow_dispatch" ]] && echo "${{ inputs.tag_name }}" || echo "${{ github.ref_name }}")
          echo "version=$TAG" >> $GITHUB_OUTPUT

      - name: Publish Linux (x64)
        run: |
          dotnet publish ${{ env.PROJECT }} \
            -c Release \
            -r linux-x64 \
            --self-contained \
            -p:Version=${{ steps.ver.outputs.version }} \
            -o publish/linux-x64

      - name: Install vpk
        run: dotnet tool install -g vpk

      - name: Pack with Velopack
        run: |
          vpk pack \
            --packId ${{ env.PACK_ID }} \
            --packVersion ${{ steps.ver.outputs.version }} \
            --packDir publish/linux-x64 \
            --mainExe ${{ env.EXE_UNIX }} \
            --outputDir velopack-output

      - name: Upload Velopack artifacts
        uses: actions/upload-artifact@v4
        with:
          name: velopack-linux-x64
          path: velopack-output/*

  ###############################################################
  # MACOS BUILD (arm64 + x64 from single runner)
  ###############################################################
  build-macos:
    name: Build macOS (arm64 + x64)
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: crt-v2

      - name: Verify tag is on "crt-v2" branch
        if: github.event_name == 'push'
        run: |
          git fetch --all
          BRANCH=$(git branch -r --contains ${{ github.sha }} | grep 'origin/crt-v2' || true)
          if [ -z "$BRANCH" ]; then
            echo "::error::This tag was not created from the \"crt-v2\" branch - aborting..."
            exit 1
          fi
          
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Set version
        id: ver
        run: |
          TAG=$([[ "${{ github.event_name }}" == "workflow_dispatch" ]] && echo "${{ inputs.tag_name }}" || echo "${{ github.ref_name }}")
          echo "version=$TAG" >> $GITHUB_OUTPUT

      - name: Publish macOS (arm64)
        run: |
          dotnet publish ${{ env.PROJECT }} \
            -c Release \
            -r osx-arm64 \
            --self-contained \
            -p:Version=${{ steps.ver.outputs.version }} \
            -o publish/macos-arm64

      - name: Publish macOS (x64)
        run: |
          dotnet publish ${{ env.PROJECT }} \
            -c Release \
            -r osx-x64 \
            --self-contained \
            -p:Version=${{ steps.ver.outputs.version }} \
            -o publish/macos-x64

      - name: Install vpk
        run: dotnet tool install -g vpk

      - name: Pack with Velopack (macOS arm64)
        run: |
          vpk pack \
            --packId ${{ env.PACK_ID }} \
            --packVersion ${{ steps.ver.outputs.version }} \
            --packDir publish/macos-arm64 \
            --mainExe ${{ env.EXE_UNIX }} \
            --channel osx-arm64 \
            --noPortable \
            --outputDir velopack-output

      - name: Pack with Velopack (macOS x64)
        run: |
          vpk pack \
            --packId ${{ env.PACK_ID }} \
            --packVersion ${{ steps.ver.outputs.version }} \
            --packDir publish/macos-x64 \
            --mainExe ${{ env.EXE_UNIX }} \
            --channel osx-x64 \
            --noPortable \
            --outputDir velopack-output

      - name: Upload Velopack artifacts
        uses: actions/upload-artifact@v4
        with:
          name: velopack-macos
          path: velopack-output/*

  ###############################################################
  # CREATE GITHUB RELEASE
  ###############################################################
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux, build-macos]
    permissions:
      contents: write
    steps:
      - name: Download all Velopack artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Set release tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ inputs.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "PoC - Vintage Repair Toolbox ${{ steps.tag.outputs.tag }}"
          body: |
            ## ⚠️ This is an ALPHA release - NOT a stable release!!!

            ### Downloads
            | Platform | File |
            |----------|------|
            | Windows x64 | [Commodore-Repair-Toolbox-win-Setup.exe](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/Commodore-Repair-Toolbox-win-Setup.exe) |
            | Linux x64 | [Commodore-Repair-Toolbox.AppImage](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/Commodore-Repair-Toolbox.AppImage) |
            | macOS arm64 Apple Silicon | [Commodore-Repair-Toolbox-osx-arm64-Setup.pkg](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/Commodore-Repair-Toolbox-osx-arm64-Setup.pkg) |
            | macOS x64 Intel | [Commodore-Repair-Toolbox-osx-x64-Setup.pkg](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/Commodore-Repair-Toolbox-osx-x64-Setup.pkg) |
          draft: false
          prerelease: true
          files: |
            release-assets/*-Setup.exe
            release-assets/*.AppImage
            release-assets/*-Setup.pkg
            release-assets/*.nupkg
            release-assets/releases.*.json
            release-assets/assets.*.json
